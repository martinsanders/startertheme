Ext.ux.Ace=Ext.extend(Ext.form.TextField,{growMin:60,growMax:1e3,mode:"text",theme:"textmate",showInvisibles:!1,selectionStyle:"line",scrollSpeed:3,showFoldWidgets:!0,useSoftTabs:!0,tabSize:4,useWrapMode:!1,fontSize:"13px",value:"",style:"padding:0",initEvents:function(){Ext.ux.Ace.superclass.initEvents.call(this),this.editor.on("focus",this.onFocus.bind(this)),this.editor.on("blur",this.onBlur.bind(this))},initComponent:function(){this.valueHolder=document.createElement("input"),this.valueHolder.type="hidden",this.valueHolder.name=this.name,this.valueHolder.value=this.value},onRender:function(e,t){this.el||(this.defaultAutoCreate={tag:"div",cls:"x-form-textarea",style:"width:100%;height:60px"}),Ext.ux.Ace.superclass.onRender.call(this,e,t);var i=ace.require("ace/lib/useragent");this.grow&&this.el.setHeight(this.growMin),this.editor=ace.edit(this.el.dom),this.editor.$blockScrolling=1/0,this.el.appendChild(this.valueHolder),this.el.dom.removeAttribute("name"),this.el.focus=this.focus.bind(this),this.editor.getSession().setValue(this.valueHolder.value),this.editor.setShowPrintMargin(!1),this.editor.getSession().setTabSize(this.tabSize),this.editor.setAutoScrollEditorIntoView(!0),i.isMac||this.editor.setDragDelay(0),this.editor.setFontSize(this.fontSize),this.editor.setFadeFoldWidgets(!1),this.setShowInvisibles(this.showInvisibles),this.setSelectionStyle(this.selectionStyle),this.setScrollSpeed(this.scrollSpeed),this.setShowFoldWidgets(this.showFoldWidgets),this.setUseSoftTabs(this.useSoftTabs),this.setUseWrapMode(this.useWrapMode),ace.require("ace/ext/language_tools"),this.editor.setOptions({enableBasicAutocompletion:!0}),this.setTheme(this.theme),this.setMode(this.mode),this.editor.getSession().on("change",function(){setTimeout(function(){this.valueHolder.value=this.editor.getSession().getValue()}.bind(this),10)}.bind(this)),this.autoSize()},onDestroy:function(){this.editor.destroy(),Ext.ux.Ace.superclass.onDestroy.call(this)},validate:function(){return!0},getErrors:function(e){return null},onResize:function(){this.editor.resize(!0)},doAutoSize:function(e){return!e.isNavKeyPress()||e.getKey()==e.ENTER},autoSize:function(){if(this.grow){var e=this.editor.getSession().getDocument().getLength(),t=this.editor.renderer.lineHeight,i=this.editor.renderer.scrollBar.getWidth(),o=this.el.getBorderWidth("tb"),n=Math.min(this.growMax,Math.max(e*t+i+o,this.growMin));n!=this.lastHeight&&(this.lastHeight=n,this.el.setHeight(n),this.editor.resize(),this.fireEvent("autosize",this,n))}},setSize:function(e,t){Ext.ux.Ace.superclass.setSize.apply(this,arguments),this.editor.resize(!0)},getValue:function(){return this.valueHolder.value},setValue:function(e){this.editor?this.editor.getSession().setValue(e):this.valueHolder.value=e,this.value=e},setMode:function(e){this.editor.getSession().setMode("ace/mode/"+e)},setTheme:function(e){this.editor.setTheme("ace/theme/"+e)},setFontSize:function(e){this.editor.setFontSize(e)},setShowInvisibles:function(e){this.editor.setShowInvisibles(e)},setSelectionStyle:function(e){this.editor.setSelectionStyle(e)},setScrollSpeed:function(e){this.editor.setScrollSpeed(e)},setShowFoldWidgets:function(e){this.editor.setShowFoldWidgets(e)},setUseSoftTabs:function(e){this.editor.getSession().setUseSoftTabs(e)},setUseWrapMode:function(e){this.editor.getSession().setUseWrapMode(e)},insertAtCursor:function(e){return this.editor.insert(e)},focus:function(){this.editor.focus()},blur:function(){this.editor.blur()}}),Ext.reg("ace",Ext.ux.Ace),Ext.namespace("MODx.ux"),MODx.ux.Ace=Ext.extend(Ext.ux.Ace,{mimeType:"text/plain",theme:MODx.config["ace.theme"]||"textmate",fontSize:MODx.config["ace.font_size"]||"13px",useWrapMode:1==MODx.config["ace.word_wrap"],useSoftTabs:1==MODx.config["ace.soft_tabs"],tabSize:1*MODx.config["ace.tab_size"]||4,showFoldWidgets:1==MODx.config["ace.fold_widgets"],showInvisibles:1==MODx.config["ace.show_invisibles"],modxTags:!1,initComponent:function(){MODx.ux.Ace.superclass.initComponent.call(this);var e=ace.require("ace/config"),t=MODx.config.assets_url+"components/ace/ace";e.set("basePath",t),e.set("modePath",t),e.set("themePath",t),e.set("workerPath",t),this.windows=[]},onRender:function(e,t){MODx.ux.Ace.superclass.onRender.call(this,e,t);var i=ace.require("ace/token_iterator").TokenIterator,o=ace.require("ace/lib/useragent"),n=o.isMac?"Command + F12":"Ctrl + F11";if(this.maximizeTitle=_("ui_ace.maximize")+" ("+n+")",this.minimizeTitle=_("ui_ace.minimize")+" ("+n+")",this.maximizer=document.createElement("div"),this.maximizer.title=this.maximizeTitle,this.maximizer.className="ace_maximizer",this.maximizer.onmousedown=function(e){e.preventDefault()},this.maximizer.onclick=function(e){this.fullScreen(),e.preventDefault()}.bind(this),this.editor.renderer.scroller.appendChild(this.maximizer),this.setMimeType(this.mimeType),!MODx.ux.Ace.initialized){var r="                .ace_maximized {position: fixed; border: none; top: 0; left: 0; right: 0; bottom: 0; width: auto !important; height: auto !important;z-index: 100}                .ace_maximizer {position: absolute; width: 16px; height: 16px; top: 3px; right: 3px; opacity: 0.7; z-index: 10; background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAABgFBMVEVmrBxkqxpjqhlkqxprryFnrB1kqxtkqxp6uzJiqRhZow9kqxpmrBxlrBtnrBxjqhlmrBxjqhptsSNkqhplqxt4tyxkqhlmrB1mrBx5uzJmrBxorR9orR5nrB1kqhlorR14uS5mrRxhqBhmrR1aoxBlqxt3titusiRlqxpiqRd4ty1rrh9hqBdjqxp3tSpaow9mrR15ujBorh5lrBxapRFmrBxkqhpjqhp5uzBhqRdnrB1rsCJlrBt6vDNorh93tipmqxxhqRhapBFbpRJnrR1mrB14uC1usiVnrB1apRFhqReq1VmLxUGv5Gyt3GOs22Cm0FKn2FyUzUyRykev4WmUz1CUy0mw5G6RzEmr11xusSOSy0iOxkKPx0Or2V6CwTuo3GGUz0+Sy0mu5W6Ry0mq1lptsCORy0iNx0OAvDOo2V5/vDOCwDmPxkOOy0mj0lWl1lqu4Gap1Viv4mms2l+s3WSPx0SKwDtusiWCwTqQxUGSyUaRykiAvDSp2l+Qx0QdWpRIAAAAS3RSTlMAAAAa4gAAlfAZMRLhuQCV1ZXwGgDwlQCy8MzY2swS2PDqEdUisvDwABn64hEA8CLh+tq5MeoAAPAZ4eKy+tr6uREiMdXq8PDqIhHgP7bQAAAA4ElEQVR42mOw5uBw52cAA351CwUWBttk30p9iIBKTmGcFgNHeEKwlBIfAwOrjmxNQaQoQ0V8TVa9PDMDg7B0RF1MdhSDGJdLfWqVqS6Ta5BfvYAzO1Arp0xVOS8bo3FGtAwnxDBuHhsRBgYNVR5uBihgZAOTTDA+AxMjiDSDCYhzW0kAtTBKGMiJgwUs7cJ8eBkZHfISjTSBXDEu5RT/akVzJo/Q4mgBE3aGisr0OqjDkupyM9MYJEMCY6UcQU73ki3LL1JjMCwtqfWEmO5U6x1gz8Ci4CYkCBEQFBLV0wYAXu4m8P20SwoAAAAASUVORK5CYII=)}                .ace_maximizer:hover {opacity: 1}            ";new MODx.ux.Ace.CodeCompleter;ace.require("ace/lib/dom").importCssString(r);var s=ace.require("ace/snippets").snippetManager,a=MODx.config["ace.snippets"]||"";s.register(s.parseSnippetFile(a),"_");var l=ace.require("ace/keyboard/hash_handler").HashHandler,c=new l;c.addCommand({name:"insertsnippet",bindKey:{win:"Tab",mac:"Tab"},exec:function(e){return s.expandWithTab(e)}});var u=function(e,t){t.keyBinding.addKeyboardHandler(c)};u({},this.editor);var d=ace.require("ace/ext/emmet");d.isSupportedMode=function(e){return e&&/css|less|scss|sass|stylus|html|php|twig|ejs|handlebars|smarty/.test(e)};ace.require("ace/lib/net").loadScript(MODx.config.assets_url+"components/ace/emmet/emmet.js",function(){d.setCore(window.emmet),this.editor.setOption("enableEmmet",!0),this.editor.on("changeMode",u),u({},this.editor)}.bind(this)),ace.require("ace/ext/keybinding_menu").init(this.editor),MODx.ux.Ace.initialized=!0}this.editor.commands.addCommand({name:"showKeyboardShortcuts",bindKey:{win:"Ctrl-Alt-H",mac:"Command-Alt-H"},exec:function(e){e.showKeyboardShortcuts()},readOnly:!0}),this.editor.commands.addCommand({name:"gotoline",bindKey:{win:"Ctrl-L",mac:"Command-Option-L"},exec:this.showGotoLineWindow.bind(this),readOnly:!0}),this.editor.commands.addCommand({name:"fullscreen",bindKey:{win:"Ctrl-F11",mac:"Command-F12"},exec:this.fullScreen.bind(this),readOnly:!0})},fullScreen:function(){this.isFullscreen?(this.maximizer.title=this.maximizeTitle,this.el.removeClass("ace_maximized")):(this.el.addClass("ace_maximized"),this.maximizer.title=this.minimizeTitle),this.isFullscreen=!this.isFullscreen,this.onResize()},setMimeType:function(e){this.setMode(MODx.ux.Ace.mimeTypes[e]||"text")},showGotoLineWindow:function(){var e;this.windows.gotoLine||(this.windows.gotoLine=this.createGotoLineWindow()),e=this.windows.gotoLine,e.show()},doGotoLine:function(){var e,t;e=this.windows.gotoLine,t=e.fp.getForm().getFieldValues("line").line,isNaN(t)||(this.editor.gotoLine(t),e.hide())},createGotoLineWindow:function(){var e=MODx.load({xtype:"modx-window",title:_("ui_ace.goto_line"),resizable:!1,maximizable:!1,allowDrop:!1,width:300,buttons:[{text:_("ui_ace.go"),scope:this,handler:this.doGotoLine},{text:_("ui_ace.close"),scope:this,handler:function(){e.hide()}}],keys:[{key:Ext.EventObject.ENTER,fn:this.doGotoLine,scope:this}],action:"gotoline",listeners:{hide:{fn:this.focus,scope:this}},fields:[{xtype:"textfield",validator:function(e){return!isNaN(e)},fieldLabel:_("ui_ace.goto_line"),name:"line",anchor:"100%",value:""}]});return e},setMode:function(e){var t=this.editor;if(!this.modxTags)return t.session.setMode("ace/mode/"+e);ace.require("ace/config").loadModule(["mode","ace/mode/"+e],function(e){var i=MODx.ux.Ace.createModxMixedMode(e.Mode);t.session.setMode(i)}.bind(this))}}),MODx.ux.Ace.replaceComponent=function(e,t,i){var o=Ext.getCmp(e);if(!o)return setTimeout(function(){Ext.getCmp(e)&&MODx.ux.Ace.replaceComponent(e,t,i)});var n=MODx.load({xtype:"modx-texteditor",enableKeyEvents:!0,anchor:o.anchor,width:"auto",height:parseInt(MODx.config["ace.height"])||o.height,name:o.name,value:o.getValue(),mimeType:t,modxTags:i});if(o.el.dom.removeAttribute("name"),o.el.setStyle("display","none"),n.render(o.el.dom.parentNode),o.setSize=function(){n.setSize.apply(n,arguments)},n.editor.on("change",function(e){o.fireEvent("change",e)}),o.on("destroy",function(){n.destroy()}),i){var r=MODx.load({xtype:"modx-treedrop",target:n,targetEl:n.el,onInsert:function(e){return this.insertAtCursor(e),this.focus(),!0}.bind(n),iframe:!0});o.on("destroy",function(){r.destroy()})}},MODx.ux.Ace.replaceTextAreas=function(e,t){e.forEach(function(e){var i=MODx.load({xtype:"modx-texteditor",width:"auto",height:parseInt(e.style.height)||200,name:e.name,value:e.value,mimeType:t||"text/html",modxTags:!0});e.name="",e.style.display="none",i.render(e.parentNode),i.editor.on("change",function(e){MODx.fireResourceFormChange()})})},MODx.ux.Ace.createModxMixedMode=function(e){function t(){function t(){i.call(this),this.$rules["modxtag-comment"]=[{token:"comment.modx",regex:"[^\\[\\]]+",merge:!0},{token:"comment.modx",regex:"\\[\\[\\-.*?\\]\\]"},{token:"comment.modx",regex:"\\s+",merge:!0},{token:"paren.rparen.comment.modx",regex:"\\]\\]",next:"pop"}],this.$rules["modxtag-start"]=[{token:["cache-flag.variable.modx","tag-token.variable.modx","tag-name.variable.modx"],regex:"(!)?([%|*|~|\\+|\\$]|(?:\\+\\+)|(?:\\*#))?([-_a-zA-Z0-9\\.]+)",push:[{include:"modxtag-filter"},{token:"tag-delimiter.keyword.operator.modx",regex:"\\?",push:[{token:"text.modx",regex:"\\s+"},{include:"modxtag-property-string"},{token:"",regex:"$"},{token:"",regex:"",next:"pop"}]},{token:"text.modx",regex:"\\s+"},{token:"",regex:"$"},{token:"",regex:"",next:"pop"}]},{token:"support.constant.paren.lparen.modx",regex:"\\[\\[",push:"modxtag-start"},{token:"text",regex:"\\s+"},{token:"support.constant.paren.rparen.tag-brackets.modx",regex:"\\]\\]",next:"pop"},{defaultToken:"text.modx"}],this.$rules["modxtag-propertyset"]=[{token:["keyword.operator.modx","support.class.modx"],regex:"(@)([-_a-zA-Z0-9\\.]+|\\[\\[.*?\\]\\])",next:"modxtag-filter"},{token:"text",regex:"\\s+"},{token:"",regex:"$"},{token:"empty",regex:"",next:"modxtag-filter"}],this.$rules["modxtag-filter"]=[{token:"filter-delimiter.keyword.operator.modx",regex:":",push:[{token:"filter-name.support.function.modx",regex:"[-_a-zA-Z0-9]+|\\[\\[.*?\\]\\]",push:"modxtag-filter-eq"},{token:"empty",regex:"",next:"pop"}]},{token:"text",regex:"\\s+"}],this.$rules["modxtag-filter-eq"]=[{token:["keyword.operator.modx"],regex:"="},{token:"string",regex:"`",push:"modxtag-filter-value"},{token:"text",regex:"\\s+"},{token:"empty",regex:"",next:"pop"}],this.$rules["modxtag-property-string"]=[{token:"entity.other.attribute-name.modx",regex:"&"},{token:"entity.other.attribute-name.modx",regex:"[-_a-zA-Z0-9]+"},{token:"string.modx",regex:"`",push:"modxtag-attribute-value"},{token:"keyword.operator.modx",regex:"="},{token:"entity.other.attribute-name.modx",regex:"[-_a-zA-Z0-9]+"},{token:"comment.modx",regex:"\\[\\[\\-.*?\\]\\]"},{token:"property-string.text.modx",regex:"\\s+"}],this.$rules["modxtag-attribute-value"]=[{token:"string.modx",regex:"[^`\\[]+",merge:!0},{token:"string.modx",regex:"[^`]+",merge:!0},{token:"string.modx",regex:"`",next:"pop",merge:!0}],this.$rules["modxtag-filter-value"]=[{token:"string.modx",regex:"[^`\\[]+",merge:!0},{token:"string.modx",regex:"\\[\\[.*?\\]\\]",merge:!0},{token:"string.modx",regex:"\\\\$",next:"pop",merge:!0},{token:"string.modx",regex:"`",next:"pop",merge:!0}];for(var e in this.$rules)this.$rules[e].unshift({token:"paren.lparen.comment.modx",regex:"\\[\\[\\-",push:"modxtag-comment",merge:!0},{token:"support.constant.paren.lparen.tag-brackets.modx",regex:"\\[\\[",push:"modxtag-start",merge:!1});this.normalizeRules()}e.call(this);var i=this.HighlightRules;if(t.prototype=i.prototype,this.HighlightRules=t,void 0===this.$behaviour)var o=ace.require("ace/mode/behaviour").Behaviour;this.$behaviour=Object.create(this.$behaviour||new o),this.$behaviour.add("brackets","insertion",function(e,t,i,o,n){if("["==n){var r=i.getSelectionRange(),s=o.doc.getTextRange(r);return""!==s?{text:"["+s+"]",selection:!1}:{text:"[]",selection:[1,1]}}if("]"==n){var a=i.getCursorPosition();if("]"==o.doc.getLine(a.row).substring(a.column,a.column+1)){if(null!==o.$findOpeningBracket("]",{column:a.column+1,row:a.row}))return{text:"",selection:[1,1]}}}}),this.$behaviour.add("brackets","deletion",function(e,t,i,o,n){var r=o.doc.getTextRange(n);if(!n.isMultiLine()&&"["==r){if("]"==o.doc.getLine(n.start.row).substring(n.start.column+1,n.start.column+2))return n.end.column++,n}}),this.$behaviour.add("string_apostrophes","insertion",function(e,t,i,o,n){if("`"==n){var r="`",s=i.getSelectionRange(),a=o.doc.getTextRange(s);if(""!==a)return{text:"`"+a+"`",selection:!1};for(var l=i.getCursorPosition(),c=o.doc.getLine(l.row),u=c.substring(l.column-1,l.column),d=o.getTokens(s.start.row),m=0,h,x=-1,p=0;p<d.length&&(h=d[p],"string.modx"==h.type?x=-1:x<0&&(x=h.value.indexOf("`")),!(h.value.length+m>s.start.column));p++)m+=d[p].value.length;if(!h||x<0&&"comment"!==h.type&&("string.modx"!==h.type||s.start.column!==h.value.length+m-1&&h.value.lastIndexOf("`")===h.value.length-1))return{text:"``",selection:[1,1]};if(h&&"string.modx"===h.type){if("`"==c.substring(l.column,l.column+1))return{text:"",selection:[1,1]}}}}),this.$behaviour.add("string_apostrophes","deletion",function(e,t,i,o,n){var r=o.doc.getTextRange(n);if(!n.isMultiLine()&&"`"==r){if("`"==o.doc.getLine(n.start.row).substring(n.start.column+1,n.start.column+2))return n.end.column++,n}})}return t.prototype=Object.create(e.prototype,{constructor:{value:t}}),new t},MODx.ux.Ace.mimeTypes={"text/x-smarty":"smarty","text/html":"html","application/xhtml+xml":"html","text/css":"css","text/x-scss":"scss","text/x-less":"less","image/svg+xml":"svg","application/xml":"xml","text/xml":"xml","text/javascript":"javascript","application/javascript":"javascript","application/json":"json","text/x-php":"php","application/x-php":"php","text/x-sql":"sql","text/x-markdown":"markdown","text/plain":"text","text/x-twig":"twig"},MODx.ux.Ace.initialized=!1,MODx.ux.Ace.CodeCompleter=function(){function e(e,t){Ext.Ajax.request({url:MODx.config.assets_url+"components/ace/completions.php",params:e,success:function(e){var i=JSON.parse(e.responseText);t(i)}})}function t(t,i){var o=0,n=[];t.forEach(function(t){var r=c[t.cacheKey];if(!r)return o++,void e(t.requestParams,function(e){o--,c[t.cacheKey]=e,n=n.concat(t.prepare(e)),o||i(null,n)});n=n.concat(t.prepare(r))}),o||i(null,n)}function i(e,t){return Object.keys(e).map(function(i){return{value:"chunk"==t?"$"+i:i,caption:i,meta:t,description:e[i],score:1e3}})}function o(e){return Object.keys(e).map(function(t){return{caption:t,snippet:t+"=`$0`",meta:"property",description:e[t],score:1e3}})}function n(e,t){var i=e.type.split(".");return t.split(".").every(function(e){return-1!==i.indexOf(e)})}function r(e){for(var t=0;t<e.length;t++){var i=e[t];if(" "!=i&&"\n"!=i&&"\r"!=i)return!1}return!0}function s(e){var t=e.getCurrentToken();if(!t)return null;if("modx"!==t.type.substring(t.type.lastIndexOf(".")+1))return null;for(;t&&n(t,"text.modx")&&r(t.value);)t=e.stepBackward();if(!t)return null;var i="object",o="",s="modSnippet";if(n(t,"tag-name")&&(o=t.value,t=e.stepBackward()),n(t,"tag-brackets")&&"[["==t.value)s="modSnippet";else if(n(t,"cache-flag"));else if(n(t,"tag-token")||n(t,"text"))switch(t.value){case"$":s="modChunk";break;case"*":s="modTemplateVar";break;case"++":s="modSystemSetting";break;default:return null}else if(n(t,"filter-name")||n(t,"filter-delimiter"))i="filter";else{if(!n(t,"attribute-name")&&!n(t,"tag-delimiter"))return null;if(!(o=function(){do{t=e.stepBackward()}while(t&&!n(t,"tag-name")&&!n(t,"modxtag-start"));return t&&n(t,"tag-name")?t.value:null}()))return null;i="property"}return{completionType:i,classKey:s,objectName:o}}var a=ace.require("ace/token_iterator").TokenIterator,l=ace.require("ace/ext/language_tools"),c={};l.addCompleter({getCompletions:function(e,n,r,l,c){var u=new a(n,r.row,r.column),d=s(u);if(!d)return c(null,{});var m=d.completionType,h=d.classKey,x=d.objectName;switch(m){case"propertyset":break;case"lexiconentry":break;case"property":t([{cacheKey:h+"."+x,requestParams:{action:"getProperties",classKey:h,key:x},prepare:function(e){return o(e,"property")}}],c);break;case"filter":t([{cacheKey:"filter",requestParams:{action:"getFilters"},prepare:function(e){return i(e,"filter")}},{cacheKey:"modSnippet",requestParams:{action:"getObjects",classKey:"modSnippet"},prepare:function(e){return i(e,"snippet")}}],c);break;case"object":var p={modSystemSetting:"setting",modTemplateVar:"tv",modSnippet:"snippet",modChunk:"chunk"};alias=p[h];var g=[];g[0]={cacheKey:h,requestParams:{action:"getObjects",classKey:h},prepare:function(e){return i(e,alias)}},"modTemplateVar"==h&&(g[1]={cacheKey:"resourcefield",requestParams:{action:"getResourceFields"},prepare:function(e){return i(e,"field")}}),t(g,c);break}}})},Ext.reg("modx-texteditor",MODx.ux.Ace);