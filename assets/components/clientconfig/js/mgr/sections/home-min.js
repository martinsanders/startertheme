ClientConfig.page.Home=function(e){e=e||{},Ext.applyIf(e,{id:"clientconfig-page-home",renderTo:"clientconfig-wrapper-div",border:!1,components:[{cls:"container",xtype:"panel",items:[{html:"<h2>"+_("clientconfig")+"</h2>",border:!1,cls:"modx-page-header",id:"clientconfig-header"},{xtype:"modx-formpanel",id:"clientconfig-formpanel-home",cls:"form-with-labels",layout:"form",border:!!ClientConfig.config.verticalTabs&&!MODx.config.connector_url,anchor:"100%",items:[{xtype:"hidden",name:"context"},{xtype:ClientConfig.config.verticalTabs?"modx-vtabs":"modx-tabs",border:!1,deferredRender:!1,defaults:{border:!1,autoHeight:!0,defaults:{border:!1}},items:this.getTabs(),stateful:!0,stateId:"clientconfig-page-home",stateEvents:["tabchange"],getState:function(){return{activeTab:this.items.indexOf(this.getActiveTab())}},headerCfg:ClientConfig.config.verticalTabs?{tag:"div",cls:"x-tab-panel-header vertical-tabs-header",id:"modx-resource-vtabs-header",html:1==MODx.config.show_tv_categories_header?'<h4 id="modx-resource-vtabs-header-title">'+_("clientconfig.categories")+"</h4>":""}:void 0}]}]}],buttons:this.getButtons(),listeners:{afterrender:this.setup}}),ClientConfig.page.Home.superclass.constructor.call(this,e)},Ext.extend(ClientConfig.page.Home,MODx.Component,{rtes:[],setup:function(){var e=this.rtes;setTimeout(function(){if(e.length>0&&MODx.loadRTE&&Ext.each(e,function(e,t){MODx.loadRTE(e)}),ClientConfig.contextAware&&ClientConfig.initialContext&&ClientConfig.initialContext.key){var t=Ext.getCmp("clientconfig-combo-contexts");t.setValue(ClientConfig.initialContext.key),t.fireEvent("select",t)}},150)},getTabs:function(){var e=[],t=[];return Ext.each(ClientConfig.data,function(n){var i=[];if(Ext.iterate(n.items,function(e){var n={name:e.key,xtype:e.xtype,fieldLabel:e.label+(e.is_required?"*":""),value:""!=e.value?e.value:e.default,description:ClientConfig.isAdmin?"<b>[[++"+e.key+"]]</b>":void 0,allowBlank:!e.is_required,anchor:"60%",id:"clientconfig-"+e.key.replace(".","-")};if(-1!==["textarea"].indexOf(n.xtype)&&(n.anchor="100%"),"richtext"==n.xtype&&(n.xtype="textarea",t.push(n.id)),"checkbox"!=n.xtype&&"xcheckbox"!=n.xtype||(n.boxLabel=n.fieldLabel,n.fieldLabel=null,n.value=1,n.checked=e.value),"datefield"==n.xtype&&(n.format=MODx.config.manager_date_format),"timefield"==n.xtype&&(n.format=MODx.config.manager_time_format),-1!==["modx-panel-tv-image","modx-panel-tv-file"].indexOf(n.xtype)&&(n.tv=e.key,n.source=e.source||MODx.config.default_media_source,n.relativeValue=""!=e.value?e.value:e.default),"colorpickerfield"==n.xtype&&(n.cls="x-colorpicker"),"password"==n.xtype&&(n.xtype="textfield",n.inputType="password"),"modx-combo"==n.xtype){var o=e.options.split("||"),a=[];Ext.each(o,function(e,t){e=e.split("=="),e[1]?a.push([e[1],e[0]]):a.push([e[0],e[0]])}),n.store=new Ext.data.ArrayStore({mode:"local",fields:["value","label"],data:a}),n.hiddenName=e.key,n.valueField="value",n.displayField="label",n.mode="local"}if(i.push(n),e.description&&e.description.length>0){var s={xtype:"label",text:e.description,cls:"desc-under"};i.push(s)}}),i.length>=1){var o={id:"clientconfig-home-tab-"+n.id,title:n.label,items:[],cls:"tvs-wrapper"};""!=n.description&&o.items.push({bodyCssClass:"panel-desc",cls:" ",html:"<p>"+n.description+"</p>"}),o.items.push({cls:"main-wrapper",items:i,xtype:"panel",layout:"form",labelAlign:"top",labelSeparator:"",width:"85%"}),e.push(o)}}),this.rtes=t,e.length<1?[{title:_("clientconfig.no_configuration_yet"),items:[{html:"<p>"+_("clientconfig.no_configuration_yet.desc")+"</p>",bodyCssClass:"panel-desc"}]}]:e},getButtons:function(){var e=[];return ClientConfig.contextAware&&e.push("-",{xtype:"panel",html:'<span style="padding-left: 1em; padding-right: 1em;">'+_("clientconfig.choose_context")+": </span>"},{emptyText:_("clientconfig.choose_context"),xtype:"clientconfig-combo-contexts",id:"clientconfig-combo-contexts",listeners:{change:{fn:this.switchContext,scope:this},select:{fn:this.switchContext,scope:this}}}),e.push({text:_("clientconfig.save_config"),handler:this.save,cls:"primary-button",scope:this,keys:[{key:MODx.config.keymap_save||"s",ctrl:!0,fn:this.save}]}),ClientConfig.isAdmin&&e.push("-",{text:'<i class="icon icon-cog"></i> '+_("clientconfig.admin"),handler:this.openAdminPanel,scope:this}),e},switchContext:function(e){var t=e.getValue(),n=Ext.getCmp("clientconfig-formpanel-home"),i=Ext.getCmp("clientconfig-header"),o=this.rtes;n.el.mask(_("loading")),MODx.Ajax.request({url:ClientConfig.config.connectorUrl,params:{action:t.length>0?"mgr/settings/getcontextaware":"mgr/settings/getglobal",context:t},listeners:{success:{fn:function(e){var t=n.getForm();t&&(ClientConfig.destroyRTEs(o),t.reset(),t.setValues(e.object),MODx.loadRTE&&Ext.each(o,function(e,t){MODx.loadRTE(e)})),n.el.unmask();var a=e.object.context_name.length>0?_("clientconfig.config_for_context",{context:e.object.context_name}):_("clientconfig");i.update("<h2>"+a+"</h2>")},scope:this},failure:{fn:function(){n.el.unmask()},scope:this},scope:this}})},save:function(){var e=Ext.getCmp("clientconfig-formpanel-home");if(e&&e.getForm()){var t=e.getForm().getValues(),n=e.find("xtype","modx-panel-tv-image");Ext.each(n,function(e){t[e.name]=t["tv"+e.name]},this);var i=e.find("xtype","modx-panel-tv-file");Ext.each(i,function(e){t[e.name]=t["tv"+e.name]},this),e.el.mask(_("saving")),MODx.Ajax.request({url:ClientConfig.config.connectorUrl,params:{action:"mgr/settings/save",values:Ext.encode(t)},listeners:{success:{fn:function(t){e.el.unmask(),MODx.msg.status({title:_("clientconfig.saved"),message:_("clientconfig.saved.text"),delay:4})},scope:this},failure:{fn:function(t){e.el.unmask()},scope:this},scope:this}})}},openAdminPanel:function(){ClientConfig.isAdmin&&MODx.loadPage(MODx.request.a,"action=admin")}}),Ext.reg("clientconfig-page-home",ClientConfig.page.Home);